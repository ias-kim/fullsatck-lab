<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link rel="icon" type="image/svg+xml" href="/vite.svg"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TodoApp + 바닐라스크립트 ⇒ jQuery</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        .todo.completed {
            text-decoration: line-through;
            color: #999;
        }

        .todo.editing > * {
            display: none;
        }

        .todo.editing .todo-edit-input {
            display: block;
        }

        .todo-edit-input {
            display: none;
        }

        #todo-list[data-filter="active"] .todo.completed {
            display: none;
        }

        #todo-list[data-filter="completed"] .todo:not(.completed) {
            display: none;
        }

    </style>
</head>
<body>

<input id="todo-input" type="text" placeholder="할 일을 입력 해주세요."/>

<ol id="todo-list" data-filter="all">

</ol>

<div>남은 할일: <span id="num-reminded-todos">0</span></div>

<div>
    <button id="btn-show-all">전체</button>
    <button id="btn-show-active">해야할</button>
    <button id="btn-show-completed">완료</button>
</div>

<div>
    <button id="btn-toggle-all">전체 완료 토글</button>
    <button id="btn-clear-completed">완료된 할일 삭제</button>
</div>
<script>
    console.log("$", $)
    const todoList = document.getElementById("todo-list");
    // 1. 할 일 목룍 생성 - 사용자가 새로운 할 일을 입력할 수 있게 하는 기능.
    // 기존 화면 -> 행동(엔터키) -> 새로운 화면

    // "선택"
    // "이벤트"
    // 데이터 가공 -> 비즈니스 로직
    // "화면의 결과"
    // "화면의 결과"
    function createTodo(todoData) {
        const {title, completed} = todoData

        const $li = $(`<li class="todo ${completed ? 'completed' : ''}">
           <input type="checkbox" ${completed ? 'checked' : ''} ><span class="title">${title}</span>
           <input class="todo-edit-input" type="text" >
           <button class="del">X</button>
           </li>`)
        $(todoList).append($li);
    }

    $("#todo-input").on("keydown", event => {
        if (event.isComposing) return;
        if (event.key === "Enter") {

            const title = $(event.target).val().trim();
            if (!title) return;
            const todoData = {title, completed: false};

            createTodo(todoData)


            $(event.target).val("")
            saveTodos();
            updateRemainingTodos();
        }
    })

    // 2. 할 일 목록 표시 - 입력된 할 일을 목록 형태로 보여주는 기능.


    // 3. 할 일 완료 표시 - 할 일의 완료 상태를 표시 및 변경할 수 있는 기능.
    $(todoList).on("click", "input[type=checkbox]", event => {
        const $todo = $(event.target).closest(".todo").toggleClass("completed")
        const $checkbox = $todo.find("input[type='checkbox']");
        $checkbox.prop("checked", $todo.hasClass("completed"));
        updateRemainingTodos();
        saveTodos()
    })

    // 4. 할 일 개수 표시 - 전체 및 남아 있는 할 일의 개수를 표시하는 기능.
    function updateRemainingTodos() {
        const num_remaining_todos = $(".todo:not(.completed)").length;
        $("#num-reminded-todos").text(num_remaining_todos);
    }

    // 5. 할 일 삭제 - 목록에서 특정 할 일을 삭제하는 기능.
    $(todoList).on("click", "button.del", event => {
        const todo = $(event.currentTarget).closest(".todo").remove();
        updateRemainingTodos()
        saveTodos()

    })

    // 6. 할 일 수정 - 이미 입력된 할 일의 내용을 수정하는 기능
    $(todoList).on("dblclick", "span.title", event => {
        const $title = $(event.currentTarget)
        const $todo = $title.closest(".todo").addClass("editing");
        const $input = $todo.find("input.todo-edit-input")
        $input.val($title.text()).focus();
    })

    $(todoList).on("keydown", "input.todo-edit-input", event => {
        if (event.isComposing) return;
        if (event.key === "Enter") {
            const $input = $(event.currentTarget);
            const $todo = $input.closest(".todo");
            const $title = $todo.find("span.title");
            $title.text($input.val())
            $todo.removeClass("editing");
            saveTodos()
        }
    })

    $(todoList).on("focusout", "input.todo-edit-input", event => {
        $(event.currentTarget).closest(".todo").removeClass("editing");
    });

    // 7. 할 일 필터링 - 완료된 할 일과 진행 중인 할 일을 구분하여 볼 수 있는 필터 기능.
    $("#btn-show-all").on("click", () => $(todoList).attr("data-filter", "all"));
    $("#btn-show-active").on("click", () => $(todoList).attr("data-filter", "active"));
    $("#btn-show-completed").on("click", () => $(todoList).attr("data-filter", "completed"));

    // 8. 할 일 일괄 완료 처리 - 모든 할 일을 한 번에 완료 처리할 수 있는 기능.
    $("#btn-toggle-all").on("click", event => {
        const isAllChecked = [...$(todoList).find(".todo")].every(todo => $(todo).hasClass("completed"));

        $(todoList).find(".todo").each((index, todo) => {
            const $todo = $(todo);
            const $checkbox = $todo.find("input[type='checkbox']");
            if (isAllChecked) {
                $todo.removeClass("completed");
                $checkbox.prop("checked", false);
            } else {
                $todo.addClass("completed");
                $checkbox.prop("checked", true);
            }
        });
        updateRemainingTodos();
        saveTodos();
    })

    // 9. 할 일 일괄 삭제 - 완료된 할 일만을 선택적으로 일괄 삭제하는 기능.
    $("#btn-clear-completed").on("click", () => {
        $(todoList).find(".todo.completed").each((index, todo) => {
            $(todo).remove();
        })
        updateRemainingTodos()
        saveTodos()
    });

    // 10. 지속성 - 데이터를 지속적으로 저장하여, 웹 페이지 새로고침 후에도 할 일 목록을 유지하는 기능.
    function saveTodos() {
        const savedTodos = [...$(todoList).find(".todo")].map(todo => {
            const title = $(todo).find("span.title").text()
            const completed = $(todo).hasClass("completed")
            return {title, completed}
        })

        // 직렬화
        localStorage.setItem("todos", JSON.stringify(savedTodos))
    }

    // 직렬화
    const savedTodos = JSON.parse(localStorage.getItem("todos") || '[]')

    // 역직렬화
    savedTodos.forEach(todoData => {
        createTodo(todoData)
    })


    updateRemainingTodos()
</script>
</body>
</html>
